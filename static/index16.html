<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Factory Digital Twin - Issue 16</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#f4f4f4; }
  h2 { margin-top: 40px; }
  .metrics { display: flex; gap: 20px; margin-bottom: 20px; }
  .card { background:white; padding:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); width: 200px; text-align:center; }
  canvas { background:white; border-radius:8px; padding:10px; }
  .controls { margin-top:20px; display:flex; gap:10px; flex-wrap: wrap; }
  .controls button, .controls input { padding:5px 10px; border-radius:5px; border:1px solid #ccc; }
  #charts-container { display: flex; flex-wrap: wrap; gap: 20px; }
  .draggable-chart {
    width: 420px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    padding: 10px;
    margin-bottom: 20px;
    cursor: move;
  }
</style>
</head>
<body>

<h1>Factory Digital Twin · Issue 16</h1>

<div class="metrics">
  <div class="card">Temp: <span id="temp">-</span> °C</div>
  <div class="card">Humidity: <span id="humidity">-</span> %</div>
  <div class="card">Total Output: <span id="total_output">-</span></div>
  <div class="card">Staffing Shifts: <span id="staffing">-</span></div>
</div>

<h2>Machine Queue & Throughput Charts</h2>
<div id="charts-container"></div>

<h2>Controls</h2>
<div class="controls">
  <button onclick="sendAction('add_shift')">Add Shift</button>
  <button onclick="sendAction('remove_shift')">Remove Shift</button>
</div>

<script>
let ws = new WebSocket(`ws://${location.host}/ws`);
let machinesData = {}; // store charts per machine

function createDraggableChart(machine) {
    const container = document.createElement('div');
    container.className = 'draggable-chart';
    container.style.width = '420px';
    container.style.background = '#fff';
    container.style.borderRadius = '8px';
    container.style.boxShadow = '0 2px 5px rgba(0,0,0,0.08)';
    container.style.padding = '10px';
    container.style.marginBottom = '20px';
    container.style.cursor = 'move';
    container.draggable = true;
    container.id = `chart_${machine.id}`;

    const title = document.createElement('h3');
    title.textContent = machine.id + ` (${machine.status})`;
    container.appendChild(title);

    const canvas = document.createElement('canvas');
    canvas.height = 180;
    container.appendChild(canvas);

    // Drag events
    container.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text/plain', container.id);
      container.style.opacity = '0.5';
    });
    container.addEventListener('dragend', (e) => {
      container.style.opacity = '1';
    });

    // Allow drop on container
    container.addEventListener('dragover', (e) => {
      e.preventDefault();
    });
    container.addEventListener('drop', (e) => {
      e.preventDefault();
      const draggedId = e.dataTransfer.getData('text/plain');
      const draggedEl = document.getElementById(draggedId);
      if (draggedEl && draggedEl !== container) {
        const parent = container.parentNode;
        parent.insertBefore(draggedEl, container);
      }
    });

    document.getElementById('charts-container').appendChild(container);

    const ctx = canvas.getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Queue',
            data: [],
            borderColor: 'blue',
            backgroundColor: 'rgba(0,0,255,0.1)',
            yAxisID: 'y1',
            spanGaps: true
          },
          {
            label: 'Throughput',
            data: [],
            borderColor: 'green',
            backgroundColor: 'rgba(0,255,0,0.1)',
            yAxisID: 'y2',
            spanGaps: true
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        stacked: false,
        plugins: { legend: { position: 'top' } },
        scales: {
          y1: { type: 'linear', position: 'left', title: { display: true, text: 'Queue (items)' } },
          y2: { type: 'linear', position: 'right', title: { display: true, text: 'Throughput (items/min)' } },
          x: { title: { display: true, text: 'Time' } }
        }
      }
    });
    machinesData[machine.id] = chart;
  }

function updateMetrics(payload){
    document.getElementById('temp').textContent = payload.ambient_temp.toFixed(1);
    document.getElementById('humidity').textContent = payload.ambient_humidity.toFixed(1);
    document.getElementById('total_output').textContent = payload.total_output;
    document.getElementById('staffing').textContent = payload.staffing_shifts;
}

function updateCharts(payload){
    payload.machines.forEach(m=>{
        if(!machinesData[m.id]) createDraggableChart(m);
        const chart = machinesData[m.id];
        const t = new Date(payload.time).toLocaleTimeString();
        // Add new points
        chart.data.labels.push(t);
        chart.data.datasets[0].data.push(m.queue);
        chart.data.datasets[1].data.push(m.total_processed*60/2); // approximate throughput per tick
        if(chart.data.labels.length>50){
            chart.data.labels.shift();
            chart.data.datasets.forEach(ds=>ds.data.shift());
        }
        chart.update();
    });
}

function sendAction(action,data={}){
    ws.send(JSON.stringify({action, ...data}));
}

ws.onmessage = (event)=>{
    const msg = JSON.parse(event.data);
    if(msg.type==='metrics'){
        updateMetrics(msg.payload);
        updateCharts(msg.payload);
    }
};

</script>

</body>
</html>
