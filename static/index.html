<!-- static/index.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Factory Floor Digital Twin Dashboard</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin: 12px; background: #f4f6f8; }
    header { display:flex; gap:16px; align-items:center; }
    .card { background:white; padding:12px; border-radius:10px; box-shadow:0 6px 20px rgba(20,20,40,0.06); margin-bottom:12px; }
    .grid { display:grid; grid-template-columns: 1fr 360px; gap:12px; }
    .machines { display:flex; flex-direction:column; gap:8px; max-height:60vh; overflow:auto; }
    .machine { display:flex; justify-content:space-between; align-items:center; padding:8px; border-radius:8px; border:1px solid #eee; }
    button { padding:8px 10px; border-radius:8px; border: none; background:#2563eb; color:white; cursor:pointer; }
    button.secondary { background:#10b981; }
    footer { margin-top:16px; color:#666; font-size:13px; }
    label { font-size:13px; color:#333 }
    input[type="number"] { width:80px; padding:6px; border-radius:6px; border:1px solid #ddd; }
    .bottleneck { color:#b91c1c; font-weight:700; }
  </style>
</head>
<body>
  <header>
    <h1>Factory Floor Digital Twin</h1>
    <div class="card" style="padding:8px;">
      <div><strong>Connection:</strong> <span id="conn">disconnected</span></div>
      <div><strong>Shifts:</strong> <span id="shifts">-</span></div>
    </div>
  </header>

  <main class="grid">
    <section>
      <div class="card">
        <h3>Live Metrics</h3>
        <div><strong>Time:</strong> <span id="time">-</span></div>
        <div><strong>Total output:</strong> <span id="total_output">0</span></div>
        <div><strong>Ambient:</strong> <span id="ambient">-</span></div>
        <div style="margin-top:8px;"><strong>Bottlenecks:</strong> <span id="bottlenecks">none</span></div>
      </div>

      <div class="card">
        <h3>Machines</h3>
        <div class="machines" id="machines"></div>
      </div>
    </section>

    <aside>
      <div class="card">
        <h3>Simulate changes</h3>

        <div style="margin-bottom:8px;">
          <label>Add shift</label><br/>
          <button id="add_shift">Add shift</button>
          <button id="remove_shift" class="secondary">Remove shift</button>
        </div>

        <div style="margin-bottom:8px;">
          <label>Toggle machine</label><br/>
          <select id="toggle_select"></select>
          <button id="toggle_machine">Toggle</button>
        </div>

        <div style="margin-bottom:8px;">
          <label>Move equipment (change position)</label><br/>
          <select id="move_select"></select>
          <input type="number" id="move_pos" min="1" value="1"/>
          <button id="move_btn">Move</button>
        </div>

        <div style="margin-bottom:8px;">
          <label>Set throughput factor (0.2 - 2.0)</label><br/>
          <select id="thr_select"></select>
          <input type="number" id="thr_val" step="0.1" min="0.2" max="2.0" value="1.0"/>
          <button id="set_thr">Set</button>
        </div>

        <div style="margin-bottom:8px;">
          <label>Add new machine</label><br/>
          <input type="text" id="new_id" placeholder="machine id" value="M_new"/>
          <input type="number" id="new_rate" placeholder="base rate" value="45"/>
          <button id="add_machine">Add machine</button>
        </div>

        <div style="margin-top:12px;">
          <small>Commands are applied to the live twin and will update the dashboard instantly.</small>
        </div>
      </div>

      <div class="card">
        <h3>Quick tips</h3>
        <ol>
          <li>Open <strong>multiple browser tabs</strong> to simulate multiple users monitoring the twin.</li>
          <li>Use <strong>Add shift</strong> to simulate more staff — output should rise.</li>
          <li>Move slow machines earlier to see <em>queue</em> changes and bottlenecks.</li>
        </ol>
      </div>
    </aside>
  </main>

  <footer>
    Built as a teaching demo — expand to connect to cloud twins, persist data, or add historical charts.
  </footer>

<script>
  let ws;
  function connect() {
    ws = new WebSocket(`ws://${location.host}/ws`);
    ws.onopen = () => {
      document.getElementById('conn').innerText = 'connected';
    };
    ws.onclose = () => {
      document.getElementById('conn').innerText = 'disconnected';
      setTimeout(connect, 1500);
    };
    ws.onmessage = (evt) => {
      const obj = JSON.parse(evt.data);
      if (obj.type === 'metrics') {
        renderMetrics(obj.payload);
      }
    };
  }

  function sendAction(actionObj) {
    if (!ws || ws.readyState !== 1) return alert("Not connected yet");
    ws.send(JSON.stringify(actionObj));
  }

  function renderMetrics(payload) {
    document.getElementById('time').innerText = payload.time;
    document.getElementById('total_output').innerText = payload.total_output;
    document.getElementById('ambient').innerText = `${payload.ambient_temp}°C, ${payload.ambient_humidity}%`;
    document.getElementById('bottlenecks').innerText = payload.bottlenecks.length ? payload.bottlenecks.join(', ') : 'none';
    document.getElementById('shifts').innerText = payload.staffing_shifts;

    const machinesDiv = document.getElementById('machines');
    machinesDiv.innerHTML = '';
    const toggleSel = document.getElementById('toggle_select');
    const moveSel = document.getElementById('move_select');
    const thrSel = document.getElementById('thr_select');
    [toggleSel, moveSel, thrSel].forEach(s => s.innerHTML = '');

    payload.machines.forEach(m => {
      const el = document.createElement('div');
      el.className = 'machine';
      el.innerHTML = `<div>
                        <strong>${m.id}</strong><br/>
                        pos:${m.position} • status:${m.status} • processed:${m.total_processed}
                      </div>
                      <div style="text-align:right">
                        <div>queue: ${m.queue}</div>
                        <div>throughput: ${m.throughput_factor}</div>
                      </div>`;
      machinesDiv.appendChild(el);

      // populate selects
      [toggleSel, moveSel, thrSel].forEach(s => {
        const o = document.createElement('option');
        o.value = m.id;
        o.text = m.id;
        s.appendChild(o);
      });
    });
  }

  // wire buttons
  document.addEventListener('DOMContentLoaded', () => {
    connect();

    document.getElementById('add_shift').onclick = () => sendAction({action:'add_shift'});
    document.getElementById('remove_shift').onclick = () => sendAction({action:'remove_shift'});
    document.getElementById('toggle_machine').onclick = () => {
      const mid = document.getElementById('toggle_select').value;
      sendAction({action:'toggle_machine', machine_id:mid});
    };
    document.getElementById('move_btn').onclick = () => {
      const mid = document.getElementById('move_select').value;
      const newpos = parseInt(document.getElementById('move_pos').value||1);
      sendAction({action:'move_equipment', machine_id:mid, new_position:newpos});
    };
    document.getElementById('set_thr').onclick = () => {
      const mid = document.getElementById('thr_select').value;
      const val = parseFloat(document.getElementById('thr_val').value||1.0);
      sendAction({action:'set_throughput', machine_id:mid, value: val});
    };
    document.getElementById('add_machine').onclick = () => {
      const id = document.getElementById('new_id').value || `M_new_${Date.now()}`;
      const rate = parseFloat(document.getElementById('new_rate').value||50);
      sendAction({action:'add_machine', machine_id:id, base_rate:rate, position: 999});
    };
  });
</script>
</body>
</html>
