<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Factory Floor Digital Twin Dashboard</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; 
      margin: 12px; 
      background: linear-gradient(135deg, #000000 0%, #764ba2 100%);
      min-height: 100vh;
    }
    header { 
      display:flex; 
      gap:16px; 
      align-items:center; 
      margin-bottom: 20px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    h1 {
      color: white;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      margin: 0;
    }
    .card { 
      background: rgba(255,255,255,0.95); 
      padding: 16px; 
      border-radius: 12px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      margin-bottom: 16px; 
    }
    .grid { 
      display: grid; 
      grid-template-columns: 1fr 400px; 
      gap: 20px; 
    }
    .machines { 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
      max-height: 65vh; 
      overflow: auto; 
    }
    .machine { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 12px; 
      border-radius: 10px; 
      border: 2px solid #e5e7eb;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      transition: all 0.3s ease;
    }
    .machine:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    .machine.offline {
      border-color: #ef4444;
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    }
    .machine.online {
      border-color: #10b981;
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    }
    button { 
      padding: 10px 16px; 
      border-radius: 8px; 
      border: none; 
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white; 
      cursor: pointer; 
      font-weight: 500;
      transition: all 0.3s ease;
      margin: 4px;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    button.secondary { 
      background: linear-gradient(135deg, #10b981 0%, #047857 100%);
    }
    button.secondary:hover {
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
    button.danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    button.danger:hover {
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }
    footer { 
      margin-top: 20px; 
      color: rgba(255,255,255,0.8); 
      font-size: 13px; 
      text-align: center;
    }
    label { 
      font-size: 14px; 
      color: #374151;
      font-weight: 500;
      display: block;
      margin-bottom: 4px;
    }
    input[type="number"], input[type="text"], input[type="password"], select { 
      padding: 8px 12px; 
      border-radius: 6px; 
      border: 2px solid #d1d5db; 
      margin-right: 8px;
      margin-bottom: 8px;
      transition: border-color 0.3s ease;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .bottleneck { 
      color: #dc2626; 
      font-weight: 700; 
      background: #fef2f2;
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-block;
    }
    .connection-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .connected {
      background: #dcfce7;
      color: #166534;
    }
    .disconnected {
      background: #fee2e2;
      color: #991b1b;
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    .metric-card {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding: 12px;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
    }
    .control-section {
      margin-bottom: 20px;
      padding: 16px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 4px solid #10b981;
    }
    .api-section {
      margin-top: 16px;
      padding: 12px;
      background: #fef3c7;
      border-radius: 8px;
      border-left: 4px solid #f59e0b;
    }
    .preset-section {
      margin-bottom: 20px;
      padding: 16px;
      background: #f0f9ff;
      border-left: 4px solid #0284c7;
      border-radius: 8px;
    }
    .preset-list {
      max-height: 150px;
      overflow-y: auto;
      margin-top: 8px;
    }
    .preset-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: white;
      margin-bottom: 4px;
      border-radius: 4px;
      border: 1px solid #e5e7eb;
    }
    
    /* Authentication Styles */
    .hidden { display: none !important; }
    .login-container { 
      max-width: 400px; 
      margin: 100px auto; 
      background: rgba(255,255,255,0.95);
      padding: 32px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    .auth-form { display: flex; flex-direction: column; gap: 16px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #374151; }
    .form-group input, .form-group select { width: 100%; box-sizing: border-box; }
    
    /* Fixed Tab Button Styles */
    .tab-buttons { 
      display: flex; 
      gap: 0; 
      margin-bottom: 20px; 
      border-radius: 8px; 
      overflow: hidden;
      border: 2px solid #e5e7eb;
      background: #f8fafc;
    }
    .tab-button { 
      flex: 1; 
      padding: 12px 16px; 
      border: none; 
      background: #e5e7eb;
      color: #4b5563;
      cursor: pointer; 
      font-weight: 500;
      font-size: 14px;
      transition: all 0.3s ease;
      border-right: 1px solid #d1d5db;
    }
    .tab-button:last-child {
      border-right: none;
    }
    .tab-button:hover {
      background: #d1d5db;
      color: #374151;
    }
    .tab-button.active { 
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white; 
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }
    
    .error { color: #dc2626; font-size: 14px; margin-top: 8px; }
    .success { color: #10b981; font-size: 14px; margin-top: 8px; }
    .user-info { display: flex; align-items: center; gap: 12px; }
    .role-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
    .role-admin { background: #fef3c7; color: #92400e; }
    .role-viewer { background: #dbeafe; color: #1e40af; }
    .admin-only { opacity: 0.5; pointer-events: none; }
    .demo-info {
      margin-top: 16px;
      padding: 12px;
      background: #f0f9ff;
      border-radius: 6px;
      font-size: 13px;
      border-left: 4px solid #0ea5e9;
    }
    .demo-info h4 {
      margin: 0 0 8px 0;
      color: #0369a1;
      font-size: 14px;
    }
    .demo-info p {
      margin: 4px 0;
      color: #0c4a6e;
    }
    .demo-info code {
      background: #e0f2fe;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      color: #0c4a6e;
    }

    /* Stages + Parallel Machines */
    .stage{
      background:linear-gradient(135deg,#f1f5f9,#e2e8f0);
      border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-bottom:12px
    }
    .stage-h{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .stage-left{display:flex;align-items:center;gap:8px}
    .stage-q{background:#eef2ff;color:#4f46e5;border-radius:999px;padding:4px 10px;font-size:12px}
    .stage-machines{
      display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px
    }
    .machine-card{
      background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:14px;position:relative
    }
    .machine-card::before{
      content:"";position:absolute;left:0;top:0;height:4px;width:100%;background:linear-gradient(90deg,#10b981,#059669)
    }
    .machine-card.off::before{background:linear-gradient(90deg,#ef4444,#dc2626)}
    .mc-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .mc-id{font-weight:600}
    .badge{font-size:11px;padding:3px 8px;border-radius:999px;text-transform:uppercase}
    .badge.on{background:#ecfdf5;color:#059669}
    .badge.off{background:#fee2e2;color:#dc2626}
    .mc-stats{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px;color:#374151}
    .mc-row{display:flex;justify-content:space-between}
    .mc-actions{display:flex;gap:8px;margin-top:8px}
    .stage-actions{display:flex;gap:8px;align-items:center}
    .mini-btn{padding:6px 10px;font-size:12px;margin:0}

    /* 3D View Styles */
    #factory_view_3d {
      position: relative;
      width: 100%;
      height: 600px;
      background-color: #f0f0f0;
      border-radius: 12px;
      overflow: hidden;
    }
    #factory_view_3d canvas {
      display: block;
    }
    #view_toggle_buttons {
        margin-bottom: 12px;
    }
    #view_toggle_buttons button {
        background: #e5e7eb;
        color: #4b5563;
    }
    #view_toggle_buttons button.active {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white; 
    }
    .machine-label {
        color: #fff;
        background: rgba(0, 0, 0, 0.6);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
        user-select: none;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>
  <!-- Login/Register Screen -->
  <div id="loginScreen" class="login-container">
    <h2 style="text-align: center; margin-bottom: 24px; color: #1f2937;">üè≠ Factory Digital Twin</h2>
    
    <div class="tab-buttons">
      <button class="tab-button active" id="loginTab">Login</button>
      <button class="tab-button" id="registerTab">Register</button>
    </div>
    
    <!-- Login Form -->
    <div id="loginForm">
      <div class="auth-form">
        <div class="form-group">
          <label>Username:</label>
          <input type="text" id="loginUsername" placeholder="Enter username" />
        </div>
        <div class="form-group">
          <label>Password:</label>
          <input type="password" id="loginPassword" placeholder="Enter password" />
        </div>
        <button id="loginBtn">Login</button>
        <div id="loginError" class="error hidden"></div>
      </div>
      
      <div class="demo-info">
        <h4>Demo Credentials:</h4>
        <p><strong>Admin:</strong> username: <code>admin</code>, password: <code>admin123</code></p>
        <p><em>Admin users can control the simulation. Create a viewer account to test read-only access.</em></p>
      </div>
    </div>
    
    <!-- Register Form -->
    <div id="registerForm" class="hidden">
      <div class="auth-form">
        <div class="form-group">
          <label>Username:</label>
          <input type="text" id="registerUsername" placeholder="Choose username (3+ chars)" />
        </div>
        <div class="form-group">
          <label>Password:</label>
          <input type="password" id="registerPassword" placeholder="Choose password (6+ chars)" />
        </div>
        <div class="form-group">
          <label>Role:</label>
          <select id="registerRole">
            <option value="viewer">Viewer (Read-only)</option>
            <option value="admin">Admin (Full control)</option>
          </select>
        </div>
        <button id="registerBtn">Register</button>
        <div id="registerError" class="error hidden"></div>
        <div id="registerSuccess" class="success hidden"></div>
      </div>
    </div>
  </div>

  <!-- Main Application -->
  <div id="mainApp" class="hidden">
    <header>
      <div style="display: flex; align-items: center; gap: 16px;">
        <img src="/static/logo.png" alt="AutoX Logo" style="height: 50px;">
        <h1>AutoX</h1>
        <div class="card" style="padding:12px;">
          <div><strong>Status:</strong> <span id="conn" class="connection-status disconnected">Disconnected</span></div>
          <div><strong>Active Shifts:</strong> <span id="shifts">-</span></div>
        </div>
      </div>
      
      <div class="user-info">
        <div class="card" style="padding: 8px;">
          <div><strong>User:</strong> <span id="currentUsername">-</span></div>
          <div><span id="currentUserRole" class="role-badge">-</span></div>
        </div>
        <button id="openPredictiveBtn" class="secondary">üìà AI Predictive Dashboard</button>
        <button id="logoutBtn" class="danger">Logout</button>
      </div>
    </header>

    <main class="grid">
      <section>
        <div class="card">
          <h3>üìä Live Metrics</h3>
          <div class="metrics-grid">
            <div class="metric-card">
              <div><strong>Time:</strong></div>
              <div id="time">-</div>
            </div>
            <div class="metric-card">
              <div><strong>Total Output:</strong></div>
              <div id="total_output">0</div>
            </div>
            <div class="metric-card">
              <div><strong>Temperature:</strong></div>
              <div id="temperature">-</div>
            </div>
            <div class="metric-card">
              <div><strong>Humidity:</strong></div>
              <div id="humidity">-</div>
            </div>
          </div>
          <div style="margin-top:16px;">
            <strong>üö® Bottlenecks:</strong> 
            <span id="bottlenecks">None detected</span>
          </div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>üß± Production Floor</h3>
                <div id="view_toggle_buttons">
                    <button id="view_2d_btn" class="active">2D View</button>
                    <button id="view_3d_btn">3D View</button>
                </div>
            </div>

            <!-- 2D Stages View -->
            <div id="stages_view">
                <div style="text-align: center; padding: 20px; color: #6b7280;">
                    Loading stages...
                </div>
            </div>

            <!-- 3D Factory View -->
            <div id="factory_view_3d" class="hidden">
                <!-- Three.js canvas will be inserted here -->
            </div>
        </div>

        <div class="card api-section">
          <h3>üîó REST API Integration</h3>
          <div style="margin-bottom: 12px;">
            <button id="fetch_machines">üîÑ Fetch Machines (GET)</button>
            <button id="fetch_presets" class="secondary">üìã Fetch Presets (GET)</button>
            <button id="refresh_dashboard" class="secondary">üìä Refresh Dashboard</button>
          </div>
          <div id="api_response" style="background: white; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 150px; overflow: auto;"></div>
        </div>
      </section>

      <aside>
        <div class="card" id="controlsCard">
          <h3>üéõÔ∏è Simulation Controls</h3>
          
          <div id="adminOnlyMessage" class="hidden" style="color: #dc2626; font-style: italic; margin-bottom: 16px; padding: 12px; background: #fef2f2; border-radius: 6px;">
            üîí Admin access required for controls. Current user has read-only access.
          </div>

          <div class="preset-section">
            <label>üíæ Configuration Presets</label>
            <div style="margin-bottom: 8px;">
              <input type="text" id="preset_name" placeholder="Preset name" style="width: 60%;"/>
              <button id="save_preset" class="secondary">üíæ Save Preset</button>
            </div>
            <div id="preset_list" class="preset-list">
              <div style="color: #6b7280; font-style: italic;">Loading presets...</div>
            </div>
          </div>

          <div class="control-section">
            <label>üë• Staffing Management</label>
            <button id="add_shift" class="secondary">‚ûï Add Shift</button>
            <button id="remove_shift" class="danger">‚ûñ Remove Shift</button>
          </div>

          <div class="control-section">
            <label>üîå Machine Power Control</label>
            <select id="toggle_select">
              <option>Select machine...</option>
            </select>
            <button id="toggle_machine">‚ö° Toggle Power</button>
          </div>

          <div class="control-section">
            <label>üìç Equipment Positioning</label>
            <select id="move_select">
              <option>Select machine...</option>
            </select>
            <input type="number" id="move_pos" min="1" value="1" placeholder="Stage"/>
            <button id="move_btn">üöö Move To Stage</button>
          </div>

          <div class="control-section">
            <label>‚öôÔ∏è Throughput Adjustment (0.2 - 2.0x)</label>
            <select id="thr_select">
              <option>Select machine...</option>
            </select>
            <input type="number" id="thr_val" step="0.1" min="0.2" max="2.0" value="1.0" placeholder="Factor"/>
            <button id="set_thr">‚öôÔ∏è Set Throughput</button>
          </div>

          <div class="control-section">
            <label>‚ûï Add New Stage With Machine</label>
            <input type="text" id="new_name" placeholder="Machine name" value="New Station"/>
            <input type="number" id="new_rate" placeholder="Items/min" value="45" min="1" max="200"/>
            <button id="add_machine">üè≠ Add Stage + Machine</button>
          </div>

          <div class="control-section">
            <label>‚ûï Add Parallel Machine To Stage</label>
            <select id="stage_select_parallel">
              <option>Select stage...</option>
            </select>
            <input type="text" id="new_parallel_id" placeholder="Machine ID (optional)" />
            <input type="number" id="new_parallel_rate" placeholder="Items/min" value="50" min="1" max="200"/>
            <button id="add_parallel_machine" class="secondary">‚ûï Add Parallel</button>
          </div>

          <div class="control-section">
            <label>üóëÔ∏è Machine Management</label>
            <select id="delete_select">
              <option>Select machine to delete...</option>
            </select>
            <button id="delete_machine" class="danger">üóëÔ∏è Delete Machine</button>
          </div>

          <div class="control-section">
            <label>üîÑ System Controls</label>
            <button id="reset_simulation" class="danger">üîÑ Reset Simulation</button>
          </div>
        </div>
      </aside>
    </main>

    <footer>
      üöÄ Enhanced factory digital twin with authentication, role-based access control, advanced monitoring, and staged parallel machines
    </footer>
  </div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
  import * as THREE from 'three';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
  import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

  let ws;
  let currentUser = null;
  let authToken = null;
  let machines_data = [];
  let stages_data = [];
  let threeApp = null;
  const carSpeed = 4.0; // Units per second

  // --- 3D Visualization ---
  
  function createMachineModel() {
      const machineGroup = new THREE.Group();
      
      const baseMaterial = new THREE.MeshStandardMaterial({ color: 0x555555, metalness: 0.8, roughness: 0.4 });
      const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0x777777, metalness: 0.6, roughness: 0.5 });

      const base = new THREE.Mesh(new THREE.BoxGeometry(2.5, 0.5, 3.5), baseMaterial);
      base.position.y = 0.25;
      machineGroup.add(base);

      const body = new THREE.Mesh(new THREE.BoxGeometry(2, 2.5, 3), bodyMaterial);
      body.position.y = 1.75;
      machineGroup.add(body);
      
      machineGroup.traverse(child => {
          if (child.isMesh) {
              child.castShadow = true;
              child.receiveShadow = true;
          }
      });

      return machineGroup;
  }

  function createCarModel() {
    const car = new THREE.Group();

    const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0xff4444, metalness: 0.6, roughness: 0.4, emissive: 0xff0000, emissiveIntensity: 0.4 });
    const glassMaterial = new THREE.MeshStandardMaterial({ color: 0xadd8e6, metalness: 0.2, roughness: 0.2, transparent: true, opacity: 0.7 });
    
    const body = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.5, 0.8), bodyMaterial);
    body.position.y = 0.35;
    car.add(body);
    
    const cabin = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.4, 0.7), glassMaterial);
    cabin.position.y = 0.8;
    cabin.position.x = -0.1;
    car.add(cabin);
    
    car.traverse(child => {
        if (child.isMesh) child.castShadow = true;
    });

    return car;
  }

  function init3D() {
    if (threeApp) return; 

    const container = document.getElementById('factory_view_3d');
    if (!container) return;

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x333333);
    scene.fog = new THREE.Fog(0x333333, 40, 80);

    const camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(15, 20, 25);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.shadowMap.enabled = true;
    container.appendChild(renderer.domElement);
    
    const labelRenderer = new CSS2DRenderer();
    labelRenderer.setSize(container.clientWidth, container.clientHeight);
    labelRenderer.domElement.style.position = 'absolute';
    labelRenderer.domElement.style.top = '0px';
    labelRenderer.domElement.style.pointerEvents = 'none'; // <-- THIS IS THE FIX
    container.appendChild(labelRenderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.target.set(0, 0, 10);

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);
    const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.8);
    hemiLight.position.set(0, 20, 0);
    scene.add(hemiLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 1);
    dirLight.position.set(30, 30, 20);
    dirLight.castShadow = true;
    dirLight.shadow.camera.top = 25;
    dirLight.shadow.camera.bottom = -25;
    dirLight.shadow.camera.left = -25;
    dirLight.shadow.camera.right = 25;
    dirLight.shadow.mapSize.width = 1024;
    dirLight.shadow.mapSize.height = 1024;
    scene.add(dirLight);

    const floor = new THREE.Mesh(
        new THREE.PlaneGeometry(100, 100), 
        new THREE.MeshStandardMaterial({ color: 0x444444, metalness: 0.2, roughness: 0.8 })
    );
    floor.rotation.x = -Math.PI / 2;
    floor.receiveShadow = true;
    scene.add(floor);
    const grid = new THREE.GridHelper(100, 50, 0x555555, 0x555555);
    scene.add(grid);
    
    const machineGroup = new THREE.Group();
    const conveyorGroup = new THREE.Group();
    const carGroup = new THREE.Group();
    scene.add(machineGroup, conveyorGroup, carGroup);

    const clock = new THREE.Clock();
    let conveyorTexture;

    const textureLoader = new THREE.TextureLoader();
    textureLoader.load('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAKUlEQVR42mP8//8/AymAJMANiF4g4kCagLiAhoEcwwA0YFwA/AFpCAGeFhD59gAAAABJRU5ErkJggg==', (texture) => {
        texture.wrapS = THREE.RepeatWrapping;
        texture.wrapT = THREE.RepeatWrapping;
        conveyorTexture = texture;
    });

    threeApp = { container, scene, camera, renderer, labelRenderer, controls, machineGroup, conveyorGroup, carGroup, clock, conveyorTexture };

    function animate() {
      requestAnimationFrame(animate);
      const delta = threeApp.clock.getDelta();

      controls.update();

      if (conveyorTexture) {
          conveyorTexture.offset.y -= delta * 0.8;
      }
      
      const pathLength = (stages_data.length || 1) * 12;
      threeApp.carGroup.children.forEach(car => {
          car.position.z += carSpeed * delta;
          if (car.position.z > pathLength) {
              car.position.z = -8;
          }
      });

      renderer.render(scene, camera);
      labelRenderer.render(scene, camera);
    }
    animate();
    
    window.addEventListener('resize', () => {
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
        labelRenderer.setSize(container.clientWidth, container.clientHeight);
    });
  }

  function update3DScene(stages) {
    if (!threeApp) return;

    const cleanup = (group) => {
        while(group.children.length > 0){ 
            const child = group.children[0];
            if (child.label) {
                child.remove(child.label);
                child.label.element.remove();
            }
            group.remove(child);
        }
    };

    cleanup(threeApp.machineGroup);
    cleanup(threeApp.conveyorGroup);

    const stageGap = 12;
    const machineGap = 4;
    
    stages.forEach((stage, stageIndex) => {
        const stageZ = stageIndex * stageGap;
        const numMachines = stage.machines.length;
        const totalWidth = numMachines * 2.5 + (numMachines - 1) * machineGap;

        stage.machines.forEach((m, machineIndex) => {
            const machineX = (machineIndex * (2.5 + machineGap)) - (totalWidth / 2) + (2.5 / 2);
            const machine = createMachineModel();
            machine.position.set(machineX, 0, stageZ);
            
            const body = machine.children[1];
            body.material = m.status === 'on' 
                ? new THREE.MeshStandardMaterial({ color: 0x229954, metalness: 0.6, roughness: 0.5, emissive: 0x27ae60, emissiveIntensity: 0.3 })
                : new THREE.MeshStandardMaterial({ color: 0xc0392b, metalness: 0.6, roughness: 0.5, emissive: 0xe74c3c, emissiveIntensity: 0.3 });
            
            threeApp.machineGroup.add(machine);

            const labelDiv = document.createElement('div');
            labelDiv.className = 'machine-label';
            labelDiv.textContent = `${m.name} (Q: ${m.queue.toFixed(0)})`;
            const machineLabel = new CSS2DObject(labelDiv);
            machineLabel.position.set(0, 3.5, 0);
            machine.add(machineLabel);
            machine.label = machineLabel;
        });

        if (stageIndex < stages.length) {
            const conveyorLength = stageGap;
            const conveyorWidth = totalWidth > 2 ? totalWidth + 1 : 3;
            const conveyorGeom = new THREE.BoxGeometry(conveyorWidth, 0.2, conveyorLength);
            
            let conveyorMat;
            if (threeApp.conveyorTexture) {
                constclonedTexture = threeApp.conveyorTexture.clone();
                clonedTexture.needsUpdate = true;
                clonedTexture.repeat.set(conveyorWidth / 2, conveyorLength / 2);
                conveyorMat = new THREE.MeshStandardMaterial({ map: clonedTexture });
            } else {
                conveyorMat = new THREE.MeshStandardMaterial({ color: 0x222222 });
            }

            const conveyor = new THREE.Mesh(conveyorGeom, conveyorMat);
            conveyor.position.set(0, 0.8, stageZ + conveyorLength / 2);
            conveyor.receiveShadow = true;
            threeApp.conveyorGroup.add(conveyor);
        }
    });

    cleanup(threeApp.carGroup);
    const totalPathLength = (stages.length || 1) * stageGap;
    const numCars = 5;
    for (let i = 0; i < numCars; i++) {
        const car = createCarModel();
        car.position.z = (i / numCars) * totalPathLength - 8;
        car.position.y = 1.0;
        threeApp.carGroup.add(car);
    }
  }

  // --- Authentication and UI Logic ---
  function getStoredToken() {
    return sessionStorage.getItem('factory_auth_token');
  }

  function storeToken(token) {
    sessionStorage.setItem('factory_auth_token', token);
    authToken = token;
  }

  function clearToken() {
    sessionStorage.removeItem('factory_auth_token');
    authToken = null;
  }

  function showLoginScreen() {
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
  }

  function showMainApp() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
  }

  function updateUIForRole(role) {
    const controlsCard = document.getElementById('controlsCard');
    const adminMessage = document.getElementById('adminOnlyMessage');
    
    if (role === 'admin') {
      controlsCard.classList.remove('admin-only');
      adminMessage.classList.add('hidden');
    } else {
      controlsCard.classList.add('admin-only');
      adminMessage.classList.remove('hidden');
    }
  }

  function updateUserDisplay(user) {
    document.getElementById('currentUsername').textContent = user.username;
    const roleSpan = document.getElementById('currentUserRole');
    roleSpan.textContent = user.role.toUpperCase();
    roleSpan.className = `role-badge role-${user.role}`;
    updateUIForRole(user.role);
  }

  async function login(username, password) {
    try {
      const response = await fetch('/api/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Login failed');
      }

      const data = await response.json();
      storeToken(data.access_token);
      currentUser = data.user;
      updateUserDisplay(currentUser);
      showMainApp();
      connect();
      fetchPresets();
      return true;
    } catch (error) {
      document.getElementById('loginError').textContent = error.message;
      document.getElementById('loginError').classList.remove('hidden');
      return false;
    }
  }

  async function register(username, password, role) {
    try {
      const response = await fetch('/api/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password, role })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Registration failed');
      }

      await response.json();
      document.getElementById('registerSuccess').textContent = 'Registration successful! You can now login.';
      document.getElementById('registerSuccess').classList.remove('hidden');
      document.getElementById('registerError').classList.add('hidden');
      
      document.getElementById('registerUsername').value = '';
      document.getElementById('registerPassword').value = '';
      
      setTimeout(() => {
        document.getElementById('loginTab').click();
      }, 1500);
      
      return true;
    } catch (error) {
      document.getElementById('registerError').textContent = error.message;
      document.getElementById('registerError').classList.remove('hidden');
      document.getElementById('registerSuccess').classList.add('hidden');
      return false;
    }
  }

  async function logout() {
    clearToken();
    currentUser = null;
    if (ws) {
      ws.close();
    }
    showLoginScreen();
  }

  async function checkAuthAndInitialize() {
    const token = getStoredToken();
    if (!token) {
      showLoginScreen();
      return;
    }

    try {
      const response = await fetch('/api/me', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (response.ok) {
        const user = await response.json();
        authToken = token;
        currentUser = user;
        updateUserDisplay(currentUser);
        showMainApp();
        connect();
        fetchPresets();
      } else {
        clearToken();
        showLoginScreen();
      }
    } catch (error) {
      clearToken();
      showLoginScreen();
    }
  }

  function connect() {
    const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${location.host}/ws${authToken ? `?token=${authToken}` : ''}`;
    ws = new WebSocket(wsUrl);
    
    ws.onopen = () => {
      document.getElementById('conn').innerText = 'Connected';
      document.getElementById('conn').className = 'connection-status connected';
    };
    
    ws.onclose = () => {
      document.getElementById('conn').innerText = 'Disconnected';
      document.getElementById('conn').className = 'connection-status disconnected';
      if (currentUser) {
        setTimeout(connect, 2000);
      }
    };
    
    ws.onerror = (error) => {
      console.error('WebSocket error:', error);
    };
    
    ws.onmessage = (evt) => {
      try {
        const obj = JSON.parse(evt.data);
        if (obj.type === 'metrics') {
          renderMetrics(obj.payload);
        } else if (obj.type === 'machines_updated') {
          machines_data = obj.machines || [];
          stages_data = obj.stages || [];
          updateMachineSelectors();
          updateStageSelector();
          renderStages(stages_data);
          update3DScene(stages_data);
        } else if (obj.type === 'auth_status') {
          // no-op
        } else if (obj.type === 'error') {
          console.error('Server error:', obj.payload);
          if (obj.payload.includes('authentication required') || obj.payload.includes('admin access required')) {
            alert(`Access denied: ${obj.payload}`);
          } else {
            alert(`Server error: ${obj.payload}`);
          }
        }
      } catch (e) {
        console.error('Error parsing message:', e, evt.data);
      }
    };
  }

  function sendAction(actionObj) {
    if (!currentUser || currentUser.role !== 'admin') {
      alert('Admin access required for this action');
      return;
    }
    
    if (!ws || ws.readyState !== WebSocket.OPEN) {
      alert("WebSocket not connected. Please wait for connection.");
      return;
    }
    ws.send(JSON.stringify(actionObj));
  }

  function renderMetrics(payload) {
    document.getElementById('time').innerText = new Date(payload.time).toLocaleString();
    document.getElementById('total_output').innerText = payload.total_output.toLocaleString();
    document.getElementById('temperature').innerText = `${payload.ambient_temp}¬∞C`;
    document.getElementById('humidity').innerText = `${payload.ambient_humidity}%`;
    
    const bottlenecksEl = document.getElementById('bottlenecks');
    if (payload.bottlenecks && payload.bottlenecks.length > 0) {
      bottlenecksEl.innerHTML = payload.bottlenecks.map(b => 
        `<span class="bottleneck">${b}</span>`
      ).join(' ');
    } else {
      bottlenecksEl.innerText = 'None detected';
    }
    
    document.getElementById('shifts').innerText = `${payload.staffing_shifts} shift${payload.staffing_shifts > 1 ? 's' : ''}`;

    machines_data = payload.machines || [];
    stages_data = payload.stages || [];
    renderStages(stages_data);
    update3DScene(stages_data);
    updateMachineSelectors();
    updateStageSelector();
  }

  function addParallelAtStage(stageId) {
    if (!currentUser || currentUser.role !== 'admin') {
      alert('Admin access required');
      return;
    }
    const name = prompt('Enter name for new parallel machine:', `Parallel @ Stage ${stageId}`);
    if (name === null) return;
    const rateStr = prompt('Enter base rate (items/min):', '50');
    if (rateStr === null) return;
    const rate = parseFloat(rateStr) || 50;
    sendAction({
      action: 'add_parallel_machine',
      stage_index: stageId,
      name: name,
      base_rate: rate
    });
  }

  async function deleteMachine(machineId) {
    if (!currentUser || currentUser.role !== 'admin') {
      alert('Admin access required');
      return;
    }
    
    try {
      const response = await fetch(`/api/machines/${machineId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${authToken}` }
      });
      const data = await response.json();
      document.getElementById('api_response').innerText = `Deleted: ${JSON.stringify(data, null, 2)}`;
    } catch (error) {
      document.getElementById('api_response').innerText = `Error: ${error.message}`;
    }
  }

  function deleteMachineInline(machineId) {
    if (!confirm(`Delete machine ${machineId}?`)) return;
    deleteMachine(machineId);
  }

  function toggleMachineInline(machineId) {
    sendAction({ action: 'toggle_machine', machine_id: machineId });
  }

  function renderStages(stages) {
    const container = document.getElementById('stages_view');
    if (!stages || stages.length === 0) {
      container.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;">No stages available</div>';
      return;
    }
    container.innerHTML = '';
    stages.forEach(st => {
      const s = document.createElement('div');
      s.className = 'stage';

      const h = document.createElement('div');
      h.className = 'stage-h';

      const left = document.createElement('div');
      left.className = 'stage-left';
      left.innerHTML = `<div><b>Stage ${st.id}</b></div><div class="stage-q">Input Queue: ${Number(st.input_queue ?? 0).toFixed(1)}</div>`;

      const right = document.createElement('div');
      right.className = 'stage-actions';
      if (currentUser && currentUser.role === 'admin') {
        const btn = document.createElement('button');
        btn.className = 'mini-btn secondary';
        btn.textContent = '‚ûï Add Parallel';
        btn.onclick = () => addParallelAtStage(st.id);
        right.appendChild(btn);
      }

      h.appendChild(left);
      h.appendChild(right);

      const mg = document.createElement('div');
      mg.className = 'stage-machines';
      (st.machines || []).forEach(m => {
        const el = document.createElement('div');
        el.className = 'machine-card' + (m.status === 'off' ? ' off' : '');
        el.innerHTML = `
          <div class="mc-head">
            <div class="mc-id">${m.name || m.id}</div>
            <span class="badge ${m.status==='on'?'on':'off'}">${m.status}</span>
          </div>
          <div class="mc-stats">
            <div class="mc-row"><span>Queue</span><b>${Number(m.queue).toFixed(1)}</b></div>
            <div class="mc-row"><span>Processed</span><b>${m.total_processed?.toLocaleString() || 0}</b></div>
            <div class="mc-row"><span>Throughput</span><b>${Number(m.throughput_factor).toFixed(2)}x</b></div>
            <div class="mc-row"><span>Uptime</span><b>${(Number(m.uptime)*100).toFixed(1)}%</b></div>
          </div>
        `;
        if (currentUser && currentUser.role === 'admin') {
          const actions = document.createElement('div');
          actions.className = 'mc-actions';
          const tBtn = document.createElement('button');
          tBtn.className = 'mini-btn';
          tBtn.textContent = '‚ö° Toggle';
          tBtn.onclick = () => toggleMachineInline(m.id);
          const dBtn = document.createElement('button');
          dBtn.className = 'mini-btn danger';
          dBtn.textContent = 'üóëÔ∏è Delete';
          dBtn.onclick = () => deleteMachineInline(m.id);
          actions.appendChild(tBtn);
          actions.appendChild(dBtn);
          el.appendChild(actions);
        }
        mg.appendChild(el);
      });
      s.appendChild(h);
      s.appendChild(mg);
      container.appendChild(s);
    });
  }

  function updateMachineSelectors() {
    const selectors = ['toggle_select', 'move_select', 'thr_select', 'delete_select'];
    
    selectors.forEach(selectorId => {
      const select = document.getElementById(selectorId);
      const currentValue = select.value;
      select.innerHTML = '<option>Select machine...</option>';
      
      machines_data.forEach(m => {
        const option = document.createElement('option');
        option.value = m.id;
        const stage = m.stage_id ?? m.position ?? '?';
        option.text = `${m.name || m.id} (Stage: ${stage})`;
        select.appendChild(option);
      });
      
      if (currentValue && machines_data.some(m => m.id === currentValue)) {
        select.value = currentValue;
      }
    });
  }

  function updateStageSelector() {
    const select = document.getElementById('stage_select_parallel');
    const keep = select.value;
    select.innerHTML = '<option>Select stage...</option>';
    (stages_data || []).forEach(st => {
      const o = document.createElement('option');
      o.value = st.id;
      o.text = `Stage ${st.id}`;
      select.appendChild(o);
    });
    if (keep) select.value = keep;
  }

  async function fetchMachines() {
    try {
      const response = await fetch('/api/machines', {
        headers: { 'Authorization': `Bearer ${authToken}` }
      });
      const data = await response.json();
      document.getElementById('api_response').innerText = JSON.stringify(data, null, 2);
    } catch (error) {
      document.getElementById('api_response').innerText = `Error: ${error.message}`;
    }
  }

  async function fetchPresets() {
    try {
      const response = await fetch('/api/presets', {
        headers: { 'Authorization': `Bearer ${authToken}` }
      });
      const data = await response.json();
      renderPresets(data);
    } catch (error) {
      document.getElementById('preset_list').innerHTML = '<div style="color: #ef4444;">Error loading presets</div>';
    }
  }

  function renderPresets(presets) {
    const presetList = document.getElementById('preset_list');
    
    if (!presets || presets.length === 0) {
      presetList.innerHTML = '<div style="color: #6b7280; font-style: italic;">No presets saved</div>';
      return;
    }

    presetList.innerHTML = '';
    presets.forEach(preset => {
      const presetDiv = document.createElement('div');
      presetDiv.className = 'preset-item';
      presetDiv.innerHTML = `
        <div>
          <div style="font-weight: 500;">${preset.name}</div>
          <div style="font-size: 11px; color: #6b7280;">${preset.description || 'No description'}</div>
        </div>
        <div>
          <button onclick="loadPreset(${preset.id})" style="padding: 4px 8px; font-size: 11px;">Load</button>
          <button onclick="deletePreset(${preset.id})" style="padding: 4px 8px; font-size: 11px; background: #ef4444;">Del</button>
        </div>
      `;
      presetList.appendChild(presetDiv);
    });
  }

  async function savePreset() {
    if (!currentUser || currentUser.role !== 'admin') {
      alert('Admin access required');
      return;
    }
    
    const name = document.getElementById('preset_name').value.trim();
    if (!name) {
      alert('Please enter a preset name');
      return;
    }

    try {
      const response = await fetch('/api/presets', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify({
          name: name,
          description: `Saved on ${new Date().toLocaleString()}`
        })
      });

      if (response.ok) {
        document.getElementById('preset_name').value = '';
        fetchPresets();
        alert('Preset saved successfully!');
      } else {
        const error = await response.json();
        alert(`Error saving preset: ${error.detail}`);
      }
    } catch (error) {
      console.error('Error saving preset:', error);
      alert('Error saving preset');
    }
  }

  window.loadPreset = async (presetId) => { // Make accessible from inline onclick
    if (!currentUser || currentUser.role !== 'admin') {
      alert('Admin access required');
      return;
    }
    
    try {
      const response = await fetch(`/api/presets/${presetId}/load`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${authToken}` }
      });

      if (response.ok) {
        const result = await response.json();
        alert(result.message);
      } else {
        const error = await response.json();
        alert(`Error loading preset: ${error.detail}`);
      }
    } catch (error) {
      console.error('Error loading preset:', error);
      alert('Error loading preset');
    }
  }

  window.deletePreset = async (presetId) => { // Make accessible from inline onclick
    if (!currentUser || currentUser.role !== 'admin') {
      alert('Admin access required');
      return;
    }
    
    if (!confirm('Are you sure you want to delete this preset?')) {
      return;
    }

    try {
      const response = await fetch(`/api/presets/${presetId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${authToken}` }
      });

      if (response.ok) {
        fetchPresets();
        alert('Preset deleted successfully!');
      } else {
        const error = await response.json();
        alert(`Error deleting preset: ${error.detail}`);
      }
    } catch (error) {
      console.error('Error deleting preset:', error);
      alert('Error deleting preset');
    }
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', () => {
    checkAuthAndInitialize();

    document.getElementById('openPredictiveBtn').onclick = () => {
      const host = window.location.hostname;
      const proto = window.location.protocol;
      const url = `${proto}//${host}:8501/`;
      window.open(url, '_blank');
    };

    document.getElementById('loginTab').onclick = () => {
      document.getElementById('loginTab').classList.add('active');
      document.getElementById('registerTab').classList.remove('active');
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('loginError').classList.add('hidden');
    };

    document.getElementById('registerTab').onclick = () => {
      document.getElementById('registerTab').classList.add('active');
      document.getElementById('loginTab').classList.remove('active');
      document.getElementById('registerForm').classList.remove('hidden');
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('registerError').classList.add('hidden');
      document.getElementById('registerSuccess').classList.add('hidden');
    };

    document.getElementById('loginBtn').onclick = async () => {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      if (!username || !password) {
        document.getElementById('loginError').textContent = 'Please enter both username and password';
        document.getElementById('loginError').classList.remove('hidden');
        return;
      }
      
      document.getElementById('loginError').classList.add('hidden');
      await login(username, password);
    };

    document.getElementById('registerBtn').onclick = async () => {
      const username = document.getElementById('registerUsername').value.trim();
      const password = document.getElementById('registerPassword').value;
      const role = document.getElementById('registerRole').value;
      
      if (!username || !password) {
        document.getElementById('registerError').textContent = 'Please enter both username and password';
        document.getElementById('registerError').classList.remove('hidden');
        return;
      }
      
      document.getElementById('registerError').classList.add('hidden');
      await register(username, password, role);
    };

    document.getElementById('logoutBtn').onclick = logout;

    document.getElementById('loginPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('loginBtn').click();
    });
    document.getElementById('registerPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('registerBtn').click();
    });

    document.getElementById('save_preset').onclick = savePreset;
    document.getElementById('add_shift').onclick = () => sendAction({action:'add_shift'});
    document.getElementById('remove_shift').onclick = () => sendAction({action:'remove_shift'});
    
    document.getElementById('toggle_machine').onclick = () => {
      const mid = document.getElementById('toggle_select').value;
      if (!mid || mid === 'Select machine...') return alert('Please select a machine first');
      sendAction({action:'toggle_machine', machine_id:mid});
    };
    
    document.getElementById('move_btn').onclick = () => {
      const mid = document.getElementById('move_select').value;
      const newpos = parseInt(document.getElementById('move_pos').value || 1);
      if (!mid || mid === 'Select machine...') return alert('Please select a machine first');
      sendAction({action:'move_equipment', machine_id:mid, new_position:newpos});
    };
    
    document.getElementById('set_thr').onclick = () => {
      const mid = document.getElementById('thr_select').value;
      const val = parseFloat(document.getElementById('thr_val').value || 1.0);
      if (!mid || mid === 'Select machine...') return alert('Please select a machine first');
      sendAction({action:'set_throughput', machine_id:mid, value: val});
    };
    
    document.getElementById('add_machine').onclick = () => {
      const name = document.getElementById('new_name').value || `Machine_${Date.now()}`;
      const rate = parseFloat(document.getElementById('new_rate').value || 50);
      sendAction({ action:'add_machine', machine_id: `M_${Date.now()}`, name: name, base_rate: rate });
    };

    document.getElementById('add_parallel_machine').onclick = () => {
      const stageIndex = parseInt(document.getElementById('stage_select_parallel').value || '0', 10);
      if (!stageIndex) return alert('Please select a stage');
      const id = (document.getElementById('new_parallel_id').value || '').trim() || undefined;
      const rate = parseFloat(document.getElementById('new_parallel_rate').value || '50');
      sendAction({ action: 'add_parallel_machine', stage_index: stageIndex, machine_id: id, base_rate: rate });
      document.getElementById('new_parallel_id').value = '';
    };

    document.getElementById('reset_simulation').onclick = () => {
      if (confirm('Are you sure? This will restore default machines and clear all progress.')) {
        sendAction({action:'reset_simulation'});
      }
    };

    document.getElementById('fetch_machines').onclick = fetchMachines;
    document.getElementById('fetch_presets').onclick = fetchPresets;
    document.getElementById('refresh_dashboard').onclick = () => location.reload();
    
    document.getElementById('delete_machine').onclick = async () => {
      const mid = document.getElementById('delete_select').value;
      if (!mid || mid === 'Select machine...') return alert('Please select a machine to delete');
      if (confirm(`Delete machine ${mid}?`)) await deleteMachine(mid);
    };

    // View Toggler
    const view2dBtn = document.getElementById('view_2d_btn');
    const view3dBtn = document.getElementById('view_3d_btn');
    const stagesView = document.getElementById('stages_view');
    const factoryView3d = document.getElementById('factory_view_3d');

    view2dBtn.onclick = () => {
        view2dBtn.classList.add('active');
        view3dBtn.classList.remove('active');
        stagesView.classList.remove('hidden');
        factoryView3d.classList.add('hidden');
    };
    view3dBtn.onclick = () => {
        view3dBtn.classList.add('active');
        view2dBtn.classList.remove('active');
        factoryView3d.classList.remove('hidden');
        stagesView.classList.add('hidden');
        init3D(); // Initialize on first click
    };
  });
</script>
</body>
</html>