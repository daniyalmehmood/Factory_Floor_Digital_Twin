<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Factory Floor Digital Twin</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; 
      margin: 12px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .connection-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .connected { background: #dcfce7; color: #166534; }
    .disconnected { background: #fee2e2; color: #991b1b; }
    .card { 
      background: rgba(255,255,255,0.95); 
      padding: 16px; 
      border-radius: 12px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      margin-bottom: 16px; 
    }
    h1 { color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3); margin: 0; }
    button { 
      padding: 10px 16px; 
      border-radius: 8px; 
      border: none; 
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white; 
      cursor: pointer; 
      font-weight: 500;
      margin: 4px;
    }
    input, select { 
      padding: 8px 12px; 
      border-radius: 6px; 
      border: 2px solid #d1d5db; 
      margin: 4px;
    }
    .machine {
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      background: #f8fafc;
      border: 2px solid #e5e7eb;
    }
    .machine.online { border-color: #10b981; }
    .machine.offline { border-color: #ef4444; }
    .grid { display: grid; grid-template-columns: 1fr 400px; gap: 20px; }
  </style>
</head>
<body>
  <header>
    <h1>üè≠ Factory Floor Digital Twin</h1>
    <div class="card" style="padding:12px;">
      <div><strong>Status:</strong> <span id="conn" class="connection-status disconnected">Disconnected</span></div>
      <div><strong>Active Shifts:</strong> <span id="shifts">-</span></div>
      <div><strong>API Key:</strong> <span id="api_status">hidden</span></div>
    </div>
  </header>

  <main class="grid">
    <section>
      <div class="card">
        <h3>üìä Live Metrics</h3>
        <div>
          <div><strong>Time:</strong> <span id="time">-</span></div>
          <div><strong>Total Output:</strong> <span id="total_output">0</span></div>
          <div><strong>Temperature:</strong> <span id="temperature">-</span></div>
          <div><strong>Humidity:</strong> <span id="humidity">-</span></div>
          <div><strong>üö® Bottlenecks:</strong> <span id="bottlenecks">None detected</span></div>
        </div>
      </div>

      <div class="card">
        <h3>üîß Production Machines</h3>
        <div id="machines">Loading machines...</div>
      </div>
    </section>

    <aside>
      <div class="card">
        <h3>üéõÔ∏è Simulation Controls</h3>
        
        <div style="margin-bottom: 16px;">
          <label>üîë API Key:</label>
          <input type="text" id="api_key" placeholder="secret123" value="secret123"/>
          <button id="save_key">Save</button>
        </div>

        <div style="margin-bottom: 16px;">
          <button id="add_shift">‚ûï Add Shift</button>
          <button id="remove_shift">‚ûñ Remove Shift</button>
        </div>

        <div style="margin-bottom: 16px;">
          <label>Toggle Machine:</label>
          <select id="toggle_select"><option>Select machine...</option></select>
          <button id="toggle_machine">‚ö° Toggle</button>
        </div>

        <div style="margin-bottom: 16px;">
          <label>Set Throughput:</label>
          <select id="thr_select"><option>Select machine...</option></select>
          <input type="number" id="thr_val" step="0.1" min="0.2" max="2.0" value="1.0"/>
          <button id="set_thr">Set</button>
        </div>
      </div>
    </aside>
  </main>

<script>
  let ws;
  let apiKey = "secret123";
  let machines_data = [];

  function connect() {
    const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${location.host}/ws`;
    console.log('Connecting to WebSocket:', wsUrl);
    
    ws = new WebSocket(wsUrl);
    
    ws.onopen = () => {
      console.log('WebSocket connected');
      document.getElementById('conn').innerText = 'Connected';
      document.getElementById('conn').className = 'connection-status connected';
    };
    
    ws.onclose = () => {
      console.log('WebSocket disconnected, attempting to reconnect...');
      document.getElementById('conn').innerText = 'Disconnected';
      document.getElementById('conn').className = 'connection-status disconnected';
      setTimeout(connect, 2000);
    };
    
    ws.onerror = (error) => {
      console.error('WebSocket error:', error);
    };
    
    ws.onmessage = (evt) => {
      try {
        const obj = JSON.parse(evt.data);
        console.log('Received message:', obj);
        
        if (obj.type === 'metrics') {
          renderMetrics(obj.payload);
        } else if (obj.type === 'error') {
          console.error('Server error:', obj.payload);
          alert(`Server error: ${obj.payload}`);
        }
      } catch (e) {
        console.error('Error parsing message:', e, evt.data);
      }
    };
  }

  function sendAction(actionObj) {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
      alert("WebSocket not connected. Please wait for connection.");
      return;
    }
    console.log('Sending action:', actionObj);
    ws.send(JSON.stringify(actionObj));
  }

  function renderMetrics(payload) {
    document.getElementById('time').innerText = new Date(payload.time).toLocaleString();
    document.getElementById('total_output').innerText = payload.total_output.toLocaleString();
    document.getElementById('temperature').innerText = `${payload.ambient_temp}¬∞C`;
    document.getElementById('humidity').innerText = `${payload.ambient_humidity}%`;
    document.getElementById('shifts').innerText = `${payload.staffing_shifts} shift${payload.staffing_shifts > 1 ? 's' : ''}`;
    
    const bottlenecksEl = document.getElementById('bottlenecks');
    if (payload.bottlenecks && payload.bottlenecks.length > 0) {
      bottlenecksEl.innerHTML = payload.bottlenecks.map(b => 
        `<span style="color: #dc2626; font-weight: bold;">${b}</span>`
      ).join(' ');
    } else {
      bottlenecksEl.innerText = 'None detected';
    }

    machines_data = payload.machines || [];
    renderMachines(machines_data);
    updateMachineSelectors();
  }

  function renderMachines(machines) {
    const machinesDiv = document.getElementById('machines');
    
    if (!machines || machines.length === 0) {
      machinesDiv.innerHTML = '<div>No machines available</div>';
      return;
    }

    machinesDiv.innerHTML = '';
    
    machines.forEach(m => {
      const el = document.createElement('div');
      el.className = `machine ${m.status === 'on' ? 'online' : 'offline'}`;
      
      const statusIcon = m.status === 'on' ? 'üü¢' : 'üî¥';
      
      el.innerHTML = `
        <div style="display: flex; justify-content: space-between;">
          <div>
            <strong>${statusIcon} ${m.name || m.id}</strong>
            <div>Position: ${m.position} ‚Ä¢ Status: ${m.status.toUpperCase()}</div>
          </div>
          <div style="text-align: right;">
            <div>Queue: ${Math.round(m.queue * 10) / 10}</div>
            <div>Rate: ${m.base_rate}/min</div>
            <div>Efficiency: ${Math.round(m.throughput_factor * 100)}%</div>
            <div>Uptime: ${Math.round(m.uptime * 100)}%</div>
          </div>
        </div>
      `;
      machinesDiv.appendChild(el);
    });
  }

  function updateMachineSelectors() {
    const selectors = ['toggle_select', 'thr_select'];
    
    selectors.forEach(selectorId => {
      const select = document.getElementById(selectorId);
      const currentValue = select.value;
      select.innerHTML = '<option>Select machine...</option>';
      
      machines_data.forEach(m => {
        const option = document.createElement('option');
        option.value = m.id;
        option.text = `${m.name || m.id} (Pos: ${m.position})`;
        select.appendChild(option);
      });
      
      if (currentValue && machines_data.some(m => m.id === currentValue)) {
        select.value = currentValue;
      }
    });
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', () => {
    connect();

    document.getElementById('save_key').onclick = () => {
      apiKey = document.getElementById('api_key').value.trim() || "secret123";
      document.getElementById('api_status').innerText = "stored";
      console.log('API key set to:', apiKey);
    };

    document.getElementById('add_shift').onclick = () => 
      sendAction({action:'add_shift', api_key: apiKey});
    
    document.getElementById('remove_shift').onclick = () => 
      sendAction({action:'remove_shift', api_key: apiKey});
    
    document.getElementById('toggle_machine').onclick = () => {
      const mid = document.getElementById('toggle_select').value;
      if (!mid || mid === 'Select machine...') {
        alert('Please select a machine first');
        return;
      }
      sendAction({action:'toggle_machine', machine_id:mid, api_key: apiKey});
    };
    
    document.getElementById('set_thr').onclick = () => {
      const mid = document.getElementById('thr_select').value;
      const val = parseFloat(document.getElementById('thr_val').value || 1.0);
      if (!mid || mid === 'Select machine...') {
        alert('Please select a machine first');
        return;
      }
      sendAction({action:'set_throughput', machine_id:mid, value: val, api_key: apiKey});
    };
  });
</script>
</body>
</html>